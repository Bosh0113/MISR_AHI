import os
import re
import ssl
import urllib.request
import time
from MisrToolkit import orbit_to_time_range


MISR_TOA_FOLDER = '/disk1/workspace/20221008/TOA4COM'

ssl._create_default_https_context = ssl._create_unverified_context


def download_MISR_MIL2TCST02_HDF(folder, path, orbit):
    time_range = orbit_to_time_range(orbit)
    s_time = time_range[0]
    matchObj = re.search(r'(\d+)-(\d+)-(\d+)T', str(s_time))
    yy = matchObj.group(1)
    mm = matchObj.group(2)
    dd = matchObj.group(3)
    t = str(yy) + '.' + str(mm) + '.' + str(dd)
    P = 'P' + (3-len(str(path)))*'0' + str(path)
    O_ = 'O' + (6-len(str(orbit)))*'0' + str(orbit)
    F = 'F' + '05'
    v = '0011'
    base_url = 'https://opendap.larc.nasa.gov/opendap/MISR/MIL2TCAL.002'
    filename = 'MISR_AM1_TC_ALBEDO_' + P + '_' + O_ + '_' + F + '_' + v + '.hdf'

    download_url = base_url + '/' + t + '/' + filename
    storage_path = folder + '/' + filename

    if os.path.exists(storage_path):
        return storage_path
    else:
        try:
            urllib.request.urlretrieve(download_url, filename=storage_path)
            print('Download: ' + download_url)
            return storage_path
        except Exception as e:
            print('Error: ' + download_url)
            print(e)
            return ''


if __name__ == "__main__":
    start = time.perf_counter()
    paths = [106, 106, 106, 106, 106, 106, 106, 106, 106, 106, 106, 106, 106, 106, 106, 106, 106, 106, 106, 106, 106, 106, 106, 106, 106, 106, 106, 106, 106, 106, 106, 106, 106, 106, 106, 106, 106, 106, 106, 106, 106, 106, 106, 106, 106, 106, 106, 106, 106, 106, 106, 106, 106, 106, 106, 106, 106, 106, 106, 106, 106, 106, 106, 106, 106, 106, 106, 106, 107, 107, 107, 107, 107, 107, 107, 107, 107, 107, 107, 107, 107, 107, 107, 107, 107, 107, 107, 107, 107, 107, 107, 107, 107, 107, 107, 107, 107, 107, 107, 107, 107, 107, 108, 108, 108, 108, 108, 108, 108, 108, 108, 108, 108, 108, 108, 108, 108, 108, 108, 108, 108, 108, 108, 108, 108, 108, 108, 108, 108, 108, 108, 108, 108, 108, 108, 108, 108, 108, 109, 109, 109, 109, 109, 109, 109, 109, 109, 109, 109, 109, 109, 109, 109, 109, 109, 109, 109, 109, 109, 109, 109, 109, 109, 109, 109, 109, 109, 109, 109, 109, 109, 109, 109, 109, 109, 109, 109, 109, 109, 109, 109, 109, 109, 109, 109, 109, 109, 109, 109, 109, 109, 109, 109, 109, 109, 109, 109, 109, 109, 109, 109, 109, 109, 109, 109, 109, 109, 109, 109, 109, 109, 109, 109, 109, 109, 109, 109, 109, 109, 109, 109, 109, 109, 109, 109, 109, 109, 107, 107, 107, 107, 107, 107, 107, 107, 107, 107, 107, 107, 107, 107, 107, 107, 107, 107, 107, 107, 107, 107, 107, 107, 107, 107, 107, 107, 107, 107, 107, 107, 107, 107, 107, 107, 107, 107, 107, 107, 107, 107, 107, 107, 107, 107, 107, 107, 107, 107, 107, 107, 107, 107, 107, 107, 107, 107, 107, 107, 107, 107, 107, 107, 107, 107, 107, 107, 107, 99, 99, 99, 99, 99, 99, 99, 99, 99, 99, 99, 99, 99, 99, 99, 99, 99, 99, 99, 99, 99, 99, 99, 99, 99, 99, 99, 99, 99, 99, 99, 99, 99, 99, 99, 99, 99, 99, 99, 99, 99, 99, 99, 99, 99, 99, 99, 99, 99, 99, 99, 99, 99, 99, 99, 99, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100]
    orbits = [90851, 91084, 91317, 91550, 91783, 92016, 92249, 92482, 92715, 92948, 93181, 93414, 93647, 93880, 94113, 94346, 94579, 94812, 95045, 95278, 95511, 95744, 95977, 96210, 96443, 96676, 96909, 97142, 97375, 97608, 97841, 98074, 98307, 98540, 98773, 99006, 99239, 99472, 99705, 99938, 100171, 100404, 100637, 100870, 101103, 101336, 101569, 101802, 102035, 102268, 102501, 102734, 102967, 103200, 103433, 103666, 103899, 104132, 104365, 104598, 104831, 105064, 105297, 105530, 105763, 105996, 106229, 106462, 90953, 91419, 91652, 91885, 92118, 92351, 92584, 92817, 93050, 93283, 95613, 95846, 96079, 96312, 96545, 96778, 97011, 100972, 101205, 101438, 101671, 101904, 102137, 103768, 104001, 104234, 104467, 104700, 104933, 105166, 105865, 106098, 106331, 106564, 91521, 91754, 93618, 93851, 94084, 94317, 94550, 94783, 95016, 95249, 95482, 97346, 97579, 97812, 98045, 98278, 98511, 98744, 98977, 99210, 99443, 99676, 99909, 100142, 100375, 100608, 100841, 102239, 102472, 102705, 102938, 103171, 103404, 103637, 105501, 105734, 90691, 90924, 91157, 91390, 91856, 92089, 92322, 92555, 92788, 93021, 93254, 95584, 95817, 96050, 96283, 96516, 96749, 96982, 100943, 101176, 101409, 101642, 101875, 102108, 103739, 103972, 104205, 104438, 104671, 104904, 105137, 105370, 105836, 106069, 106302, 106535, 90691, 90924, 91157, 91390, 91623, 91856, 92089, 92322, 92555, 92788, 93021, 93254, 93487, 93720, 93953, 94885, 95118, 95351, 95584, 95817, 96050, 96283, 96516, 96749, 96982, 97215, 97448, 100710, 100943, 101176, 101409, 101642, 101875, 102108, 102341, 102574, 102807, 103040, 103273, 103506, 103739, 103972, 104205, 104438, 104671, 104904, 105137, 105370, 105603, 105836, 106069, 106302, 106535, 90720, 90953, 91186, 91419, 91652, 91885, 92118, 92351, 92584, 92817, 93050, 93283, 93516, 93749, 93982, 94215, 94448, 94681, 94914, 95147, 95380, 95613, 95846, 96079, 96312, 96545, 96778, 97011, 97244, 97477, 97710, 97943, 98176, 98409, 98642, 98875, 99108, 99341, 99574, 99807, 100040, 100273, 100506, 100739, 100972, 101205, 101438, 101671, 101904, 102137, 102370, 102603, 102836, 103069, 103302, 103535, 103768, 104001, 104234, 104467, 104700, 104933, 105166, 105399, 105632, 105865, 106098, 106331, 106564, 91069, 91302, 91535, 91768, 92001, 92234, 92467, 92700, 92933, 93166, 93399, 93632, 93865, 94098, 94331, 94564, 94797, 95030, 95263, 96428, 96661, 96894, 97127, 97360, 97593, 97826, 98059, 98292, 98525, 98758, 98991, 99224, 99457, 99690, 99923, 100156, 100389, 100622, 101787, 102020, 102253, 102486, 102719, 102952, 103185, 103418, 103651, 103884, 104117, 104350, 104583, 104816, 105049, 105282, 105515, 105748, 91171, 91404, 91637, 91870, 92103, 92336, 92569, 92802, 93035, 93268, 93501, 93734, 93967, 94200, 94433, 94666, 94899, 95132, 96530, 96763, 96996, 97229, 97462, 97695, 97928, 98161, 98394, 98627, 98860, 99093, 99326, 99559, 99792, 100025, 100258, 100491, 101656, 101889, 102122, 102355, 102588, 102821, 103054, 103287, 103520, 103753, 103986, 104219, 104452, 104685, 104918, 105151, 105384, 105617, 105850]
    for idx in range(len(paths)):
        print(str(idx+1) + '/' + str(len(paths)))
        path = paths[idx]
        orbit = orbits[idx]
        download_MISR_MIL2TCST02_HDF(MISR_TOA_FOLDER, path, orbit)

    end = time.perf_counter()
    print("Run time: ", end - start, 's')